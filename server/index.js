"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.initializeServer=initializeServer;const express_1=__importDefault(require("express")),cors_1=__importDefault(require("cors")),dotenv_1=__importDefault(require("dotenv")),path_1=__importDefault(require("path")),generation_routes_1=require("./api/routes/generation.routes"),models_routes_1=require("./api/routes/models.routes"),status_routes_1=require("./api/routes/status.routes"),sse_routes_1=require("./api/routes/sse.routes"),workflow_routes_1=__importDefault(require("./api/routes/workflow.routes")),workflow_sse_routes_1=__importDefault(require("./api/routes/workflow.sse.routes")),templates_routes_1=__importDefault(require("./api/routes/templates.routes")),generation_service_1=require("../services/generation.service"),FileCleanupService_1=require("./services/utils/FileCleanupService"),health_validation_1=require("./api/validation/health.validation"),ClientManager_1=require("./services/ai/shared/ClientManager"),logger_1=require("./utils/logger");async function gracefulShutdown(e){logger_1.logger.info(`${e} received - starting graceful shutdown`);try{const e=ClientManager_1.ClientManager.getInstance();e.isReady()&&(await e.cleanup(),logger_1.logger.info("✅ ClientManager cleanup completed")),logger_1.logger.info("✅ Graceful shutdown completed"),process.exit(0)}catch(e){logger_1.logger.error("❌ Error during graceful shutdown:",e),process.exit(1)}}dotenv_1.default.config({quiet:!0}),process.on("uncaughtException",e=>{logger_1.logger.error("Uncaught Exception:",e),logger_1.logger.error("Stack trace:",e.stack),"production"===process.env.NODE_ENV&&process.exit(1)}),process.on("unhandledRejection",(e,r)=>{const t=e instanceof Error?e.message:String(e);t&&t.toLowerCase().includes("workflow cancelled")?logger_1.logger.info("WORKFLOW CANCELLED"):(logger_1.logger.error("Unhandled Rejection at:",r,"reason:",e),"production"===process.env.NODE_ENV&&process.exit(1))}),process.on("SIGTERM",()=>gracefulShutdown("SIGTERM")),process.on("SIGINT",()=>gracefulShutdown("SIGINT"));const app=(0,express_1.default)(),PORT=process.env.PORT||3e3;function initializeServer(e,r){const t=e||app,o={origin:"production"!==process.env.NODE_ENV||process.env.FRONTEND_URL,credentials:!0,methods:["GET","POST","PUT","DELETE","OPTIONS"],allowedHeaders:["Content-Type","Authorization","X-User-ID"]};t.use((0,cors_1.default)(o)),t.use(express_1.default.json()),t.use(express_1.default.urlencoded({extended:!0}));const s="production"===process.env.NODE_ENV?path_1.default.join(__dirname,"../../../client"):path_1.default.join(__dirname,"../");return t.use(express_1.default.static(s)),t.use("/media",(e,r,t)=>{logger_1.logger.debug(`[MEDIA] Request for: ${e.path}`),logger_1.logger.debug(`[MEDIA] Full path: ${path_1.default.join(process.cwd(),"output",e.path)}`),t()}),t.use("/assets",express_1.default.static(path_1.default.join(process.cwd(),"assets"))),t.use("/media",express_1.default.static(path_1.default.join(process.cwd(),"output"),{setHeaders:(e,r)=>{r.endsWith(".wav")?e.setHeader("Content-Type","audio/wav"):r.endsWith(".mp3")?e.setHeader("Content-Type","audio/mpeg"):r.endsWith(".mp4")?e.setHeader("Content-Type","video/mp4"):r.endsWith(".webm")?e.setHeader("Content-Type","video/webm"):r.endsWith(".png")?e.setHeader("Content-Type","image/png"):r.endsWith(".jpg")||r.endsWith(".jpeg")?e.setHeader("Content-Type","image/jpeg"):r.endsWith(".webp")&&e.setHeader("Content-Type","image/webp"),e.setHeader("Access-Control-Allow-Origin","*"),e.setHeader("Access-Control-Allow-Methods","GET, HEAD, OPTIONS")}})),t.get("/health",...health_validation_1.validateHealthCheck,(e,r)=>{const t=ClientManager_1.ClientManager.getInstance();r.json({status:"ok",timestamp:(new Date).toISOString(),service:"video-generation-api",environment:process.env.NODE_ENV||"development",clients:{initialized:t.isReady(),metrics:t.isReady()?t.getMetrics():null},apiKeys:{replicate:!!process.env.REPLICATE_API_TOKEN,openrouter:!!process.env.OPENROUTER_API_KEY}})}),t.use("/api/generate",generation_routes_1.generationRoutes),t.use("/api/models",models_routes_1.modelRoutes),t.use("/api/status",status_routes_1.statusRoutes),t.use("/api/sse",sse_routes_1.sseRoutes),t.use("/api/workflow",workflow_routes_1.default),t.use("/api/workflow/sse",workflow_sse_routes_1.default),t.use("/api/templates",templates_routes_1.default),"production"!==process.env.NODE_ENV&&"true"===process.env.ENABLE_TEST_ROUTES&&console.warn("[INFO] Test routes are disabled. Set ENABLE_TEST_ROUTES=true to enable them."),initializeServices(),t}async function initializeServices(){try{const e=FileCleanupService_1.FileCleanupService.getInstance();await e.initialize(),setInterval(()=>{try{generation_service_1.generationService.cleanupOldJobs()}catch(e){logger_1.logger.error("Error cleaning up old jobs:",e)}},18e5)}catch(e){logger_1.logger.error("Error during service initialization:",e)}}module.parent||(initializeServer(),app.use((e,r)=>{r.status(404).json({error:"Not Found",message:`Route ${e.method} ${e.path} not found`,timestamp:(new Date).toISOString()})}),app.use((e,r,t,o)=>{logger_1.logger.error("Error:",e);const s=e.status||500,i=e.message||"Internal Server Error";t.status(s).json({error:500===s?"Internal Server Error":e.name,message:"production"===process.env.NODE_ENV&&500===s?"An error occurred processing your request":i,timestamp:(new Date).toISOString(),..."production"!==process.env.NODE_ENV&&{stack:e.stack}})}),app.listen(PORT,async()=>{logger_1.logger.info(`Server running on port ${PORT}`);try{const e=ClientManager_1.ClientManager.getInstance();await e.initialize(),logger_1.logger.info("✅ ClientManager initialized successfully - API clients ready for workflows")}catch(e){logger_1.logger.error("❌ Failed to initialize ClientManager:",e),logger_1.logger.error("Server will continue but workflows may fail without proper API credentials")}}));