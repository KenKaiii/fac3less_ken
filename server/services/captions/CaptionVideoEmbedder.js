"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,o){void 0===o&&(o=r);var i=Object.getOwnPropertyDescriptor(t,r);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,o,i)}:function(e,t,r,o){void 0===o&&(o=r),e[o]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(){var ownKeys=function(e){return ownKeys=Object.getOwnPropertyNames||function(e){var t=[];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[t.length]=r);return t},ownKeys(e)};return function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r=ownKeys(e),o=0;o<r.length;o++)"default"!==r[o]&&__createBinding(t,e,r[o]);return __setModuleDefault(t,e),t}}();Object.defineProperty(exports,"__esModule",{value:!0}),exports.CaptionVideoEmbedder=void 0;const child_process_1=require("child_process"),util_1=require("util"),fs_1=require("fs"),path=__importStar(require("path")),uuid_1=require("uuid"),logger_1=require("../../utils/logger"),execAsync=(0,util_1.promisify)(child_process_1.exec);class CaptionVideoEmbedder{outputDir;constructor(e){this.outputDir=e||process.env.CAPTION_OUTPUT_DIR||"./output/captions"}async embedCaptionsInVideo(e,t,r,o={}){if("true"===process.env.USE_MOCK_SERVICES||e.path.startsWith("/mock/")){const t=`/mock/video_with_captions_${(0,uuid_1.v4)()}.mp4`;return{...e,path:t,size:5242880,metadata:{...e.metadata,hasCaptions:!0,captionFormat:r}}}const i=`video_with_captions_${(0,uuid_1.v4)()}.mp4`,a=path.join(this.outputDir,i),n=this.buildFFmpegCommand(e.path,t,a,r,o);try{const{stdout:e,stderr:t}=await execAsync(n);e&&logger_1.logger.debug("FFmpeg stdout:",e),t&&logger_1.logger.debug("FFmpeg stderr:",t)}catch(e){throw logger_1.logger.error("FFmpeg error:",e),e}const s=await fs_1.promises.stat(a);return{...e,path:a,size:s.size,metadata:{...e.metadata,hasCaptions:!0,captionFormat:r}}}buildFFmpegCommand(e,t,r,o,i){const a=i.fontFamily||"Archivo Black",n=i.fontSize||24,s=i.position||"bottom";if("ass"===o){return`ffmpeg -i "${e}" -vf "subtitles='${t.replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(/:/g,"\\:")}'" -c:a copy "${r}"`}{let o="2";const i="";"middle"===s&&(o="5");return`ffmpeg -i "${e}" -vf "subtitles='${t.replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(/:/g,"\\:")}':force_style='${`FontName=${a.replace(" ","\\\\ ")},FontSize=${n},PrimaryColour=&HFFFFFF&,OutlineColour=&H000000&,BorderStyle=1,Outline=2,Shadow=0,Alignment=${o}${i}`}'" -c:a copy "${r}"`}}}exports.CaptionVideoEmbedder=CaptionVideoEmbedder;