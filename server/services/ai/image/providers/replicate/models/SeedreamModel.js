"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.SeedreamModel=void 0;const types_1=require("../types");const logger_1=require("../../../../../../utils/logger");class SeedreamModel extends types_1.BaseReplicateImageModel{modelId="bytedance/seedream-3:e97385a576173b08a6a87546457582b01f65bf29a4dc00f1191e884894e0bc73";replicate;config={id:"seedream-3",name:"Seedream 3",description:"High-quality photorealistic image generation with excellent prompt adherence",minWidth:512,maxWidth:2048,minHeight:512,maxHeight:2048,supportedAspectRatios:["1:1","16:9","9:16","4:3","3:4"],supportedFormats:["png","webp","jpeg"],costPerImage:.012,defaultOptions:{guidanceScale:2.5,outputFormat:"webp"}};constructor(e){super();this.replicate=e}async generateImage(e){this.validateOptions(e);const t=Date.now();const r={prompt:e.prompt,size:"regular",width:e.width||1024,height:e.height||1024,aspect_ratio:e.aspectRatio||"1:1",guidance_scale:e.guidanceScale||this.config.defaultOptions.guidanceScale,seed:e.seed};try{const a=await this.replicate.run(this.modelId,{input:r});const o=a instanceof ReadableStream?await this.streamToUrl(a):String(a);const s=(Date.now()-t)/1e3;return{url:o,format:e.outputFormat||"webp",width:r.width,height:r.height,model:this.config.name,cost:this.config.costPerImage,generationTime:s}}catch(t){logger_1.logger.error("Seedream image generation failed",{error:t instanceof Error?t.message:String(t),stack:t instanceof Error?t.stack:void 0,modelId:this.modelId,options:{prompt:e.prompt,width:e.width,height:e.height,aspectRatio:e.aspectRatio}});throw new Error(`Seedream generation failed: ${t instanceof Error?t.message:String(t)}`)}}async submitImageJob(e){this.validateOptions(e);const t={prompt:e.prompt,size:"regular",width:e.width||1024,height:e.height||1024,aspect_ratio:e.aspectRatio||"1:1",guidance_scale:e.guidanceScale||this.config.defaultOptions.guidanceScale,seed:e.seed};try{const e=await this.createPrediction(t);return{id:e.id,status:this.mapPredictionStatus(e.status),progress:0,estimatedCompletionTime:new Date(Date.now()+3e4)}}catch(e){logger_1.logger.error("Failed to submit Seedream image job",{error:e instanceof Error?e.message:String(e),stack:e instanceof Error?e.stack:void 0,modelId:this.modelId,input:t});throw new Error(`Failed to submit image job: ${e instanceof Error?e.message:String(e)}`)}}async checkJobStatus(e){try{const t=await this.getPrediction(e);const r={id:t.id,status:this.mapPredictionStatus(t.status),progress:t.logs?this.extractProgress(t.logs):0};if("succeeded"===t.status&&t.output){let e;if(Array.isArray(t.output)&&t.output.length>0)e=t.output[0];else if("string"===typeof t.output)e=t.output;else throw new Error("Unexpected output format from Replicate");r.url=e}else if("failed"===t.status)r.error="string"===typeof t.error?t.error:"Image generation failed";return r}catch(t){logger_1.logger.error("Failed to check Seedream job status",{error:t instanceof Error?t.message:String(t),stack:t instanceof Error?t.stack:void 0,jobId:e});throw new Error(`Failed to check job status: ${t instanceof Error?t.message:String(t)}`)}}mapPredictionStatus(e){switch(e){case"starting":case"pending":return"pending";case"processing":default:return"processing";case"succeeded":return"completed";case"failed":case"canceled":return"failed"}}extractProgress(e){const t=e.match(/(\d+)%/);if(t)return parseInt(t[1]);return 0}async streamToUrl(e){try{const t=e.getReader();const r=[];while(true){const{done:e,value:a}=await t.read();if(e)break;r.push(a)}const a=new Blob(r);return URL.createObjectURL(a)}catch(e){logger_1.logger.error("Failed to convert stream to URL in SeedreamModel",{error:e instanceof Error?e.message:String(e),stack:e instanceof Error?e.stack:void 0});throw new Error(`Stream conversion failed: ${e instanceof Error?e.message:String(e)}`)}}}exports.SeedreamModel=SeedreamModel;