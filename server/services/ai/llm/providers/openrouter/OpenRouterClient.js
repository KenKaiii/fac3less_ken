"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:true});exports.OpenRouterClient=void 0;const openai_1=__importDefault(require("openai"));const LLMService_1=require("../../LLMService");const OpenRouterModels_1=require("./OpenRouterModels");const OpenRouterPricing_1=require("./OpenRouterPricing");const logger_1=require("../../../../../utils/logger");class OpenRouterClient extends LLMService_1.LLMService{client=null;constructor(e){super("OpenRouter",e);const t=e.apiKey||process.env.OPENROUTER_API_KEY;if(t)this.client=new openai_1.default({baseURL:"https://openrouter.ai/api/v1",apiKey:t,dangerouslyAllowBrowser:false})}validateConfig(){const e=this.config.apiKey||process.env.OPENROUTER_API_KEY;if(!e){logger_1.logger.error("OpenRouter API key not configured");return false}if(!e.startsWith("sk-or-v1-")){logger_1.logger.error('OpenRouter API key should start with "sk-or-v1-"');return false}return true}async complete(e){if(!this.validateConfig()||!this.client)return{success:false,error:"OpenRouter API key not configured or invalid"};try{if(e.stream)if(e.onProgress)return await this.completeWithStreaming(e);const t=await this.client.chat.completions.create({model:e.model,messages:e.messages,temperature:e.temperature,max_tokens:e.maxTokens,top_p:e.topP,frequency_penalty:e.frequencyPenalty,presence_penalty:e.presencePenalty,stream:false});const o=t.choices[0];const r=t.usage;const s={id:t.id,model:t.model,content:o.message.content||"",finishReason:o.finish_reason||void 0,usage:r?{promptTokens:r.prompt_tokens,completionTokens:r.completion_tokens,totalTokens:r.total_tokens}:void 0};let n=0;if(r)n=this.estimateCost(r.prompt_tokens,r.completion_tokens,e.model);return{success:true,data:s,metadata:{provider:"OpenRouter",model:e.model,cost:n,usage:s.usage}}}catch(e){const t=e instanceof Error?e.message:"Unknown error during completion";logger_1.logger.error("OpenRouter completion error:",t);return{success:false,error:t}}}async completeWithStreaming(e){if(!this.client)return{success:false,error:"OpenRouter client not initialized"};try{const t=Math.floor(e.messages.reduce((e,t)=>e+t.content.length,0)/4);const o=e.maxTokens||2e3;const r=await this.client.chat.completions.create({model:e.model,messages:e.messages,temperature:e.temperature,max_tokens:e.maxTokens,top_p:e.topP,frequency_penalty:e.frequencyPenalty,presence_penalty:e.presencePenalty,stream:true});let s="";let n="";let i="";let a;let l=0;let c=0;for await(const t of r){c++;if(c%10===0);if(t.id)n=t.id;if(t.model)i=t.model;const r=t.choices?.[0];if(r?.delta?.content){s+=r.delta.content;l=Math.floor(s.length/4);if(e.onProgress){const t=e.onProgress(l,o);if(t instanceof Promise)await t}await new Promise(e=>setTimeout(e,0))}if(r?.finish_reason)a=r.finish_reason}const u=Math.floor(s.length/4);const p={id:n,model:i,content:s,finishReason:a,usage:{promptTokens:t,completionTokens:u,totalTokens:t+u}};const m=this.estimateCost(t,u,e.model);return{success:true,data:p,metadata:{provider:"OpenRouter",model:e.model,cost:m,usage:p.usage}}}catch(e){const t=e instanceof Error?e.message:"Unknown error during streaming completion";logger_1.logger.error("OpenRouter streaming error:",t);return{success:false,error:t}}}async listModels(){return{success:true,data:(0,OpenRouterModels_1.getAllModels)(),metadata:{provider:"OpenRouter",count:(0,OpenRouterModels_1.getAllModels)().length}}}estimateCost(e,t,o){return(0,OpenRouterPricing_1.calculateCost)(e,t,o)}}exports.OpenRouterClient=OpenRouterClient;