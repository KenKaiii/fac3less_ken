"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.ImagePromptNode=void 0;const BaseNode_1=require("./BaseNode");const openrouter_1=require("../../ai/llm/providers/openrouter/index");const DataTypes_1=require("../../../shared/types/DataTypes");const logger_1=require("../../../utils/logger");class ImagePromptNode extends BaseNode_1.BaseNode{llmClient=null;constructor(e){super({...e,type:"imagePrompt"});this.llmClient=new openrouter_1.OpenRouterClient({})}defineDefaultPorts(){return{inputs:[{name:"script",type:DataTypes_1.DataType.SCRIPT,description:"Script data with sections",required:true},{name:"visualStyle",type:DataTypes_1.DataType.TEXT,description:"Visual style for images",required:false},{name:"model",type:DataTypes_1.DataType.TEXT,description:"LLM model to use",required:false}],outputs:[{name:"imagePrompts",type:DataTypes_1.DataType.ARRAY,description:"Array of image prompt objects"}]}}async execute(e,t){const i=this.validate(e);if(i)return{success:false,error:i};try{const t=e.visualStyle||"cinematic";const i=e.model||"anthropic/claude-sonnet-4";await this.updateProgress(10);const s={cinematic:{keywords:"cinematic composition, anamorphic lens, film grain, dramatic lighting, movie scene, depth of field, professional cinematography, epic scale",guidelines:"Create movie-like shots with dramatic camera angles, shallow depth of field, volumetric lighting, atmospheric haze, and cinematic color grading. Think blockbuster film scenes.",negativePrompt:"text, words, letters, numbers, flat lighting, amateur, phone photo, low quality, cartoon, subtitles, captions"},anime:{keywords:"anime art style, manga aesthetic, vibrant saturated colors, dynamic action lines, expressive eyes, cel-shaded rendering, Japanese animation",guidelines:"Create scenes with exaggerated expressions, speed lines for motion, cherry blossoms or dramatic backgrounds, bold color contrasts, and signature anime visual tropes.",negativePrompt:"text, words, letters, realistic, photographic, western cartoon, 3D render, dull colors, uncanny valley"},"dark-fantasy":{keywords:"dark fantasy aesthetic, gothic atmosphere, mysterious fog, dramatic chiaroscuro, ethereal glow, ominous shadows, mystical elements",guidelines:"Create haunting scenes with twisted trees, ancient ruins, magical particles, dark creatures lurking, purple/blue color palette, and supernatural atmosphere.",negativePrompt:"text, words, letters, bright colors, cheerful, modern, minimalist, cartoon, comedy, daylight"},minimalist:{keywords:"minimalist design, geometric shapes, single focal point, monochromatic palette, clean composition, negative space, zen aesthetic",guidelines:"Create simple yet powerful imagery with one main subject, solid colors, geometric patterns, lots of empty space, and subtle gradients. Think Apple ad aesthetic.",negativePrompt:"text, words, letters, cluttered, busy, ornate, detailed textures, complex, vintage, multiple subjects"},cyberpunk:{keywords:"cyberpunk aesthetic, neon glow, rain-slicked streets, holographic displays, urban dystopia, tech noir, retrowave colors, blade runner style",guidelines:"Create futuristic cityscapes with neon signs (no readable text), flying vehicles, augmented humans, pink/blue/purple lighting, reflective wet surfaces, and tech elements.",negativePrompt:"text, words, letters, natural lighting, rural, historical, vintage, bright daylight, pastoral, organic"},retro:{keywords:"retro aesthetic, vintage film look, 80s/90s style, nostalgic mood, grainy texture, pastel colors, synthwave vibes, old school",guidelines:"Create scenes with retro technology, vintage clothing styles, sunset gradients, VHS effects, geometric patterns, and nostalgic atmosphere without actual text.",negativePrompt:"text, words, letters, modern tech, sharp digital, contemporary, minimalist, black and white"},surreal:{keywords:"surreal dreamscape, impossible physics, melting reality, floating objects, distorted perspective, salvador dali inspired, mind-bending",guidelines:"Create impossible scenes with floating islands, melting clocks, giant everyday objects, twisted architecture, and dream-like transitions between elements.",negativePrompt:"text, words, letters, realistic, logical, mundane, normal proportions, everyday scenes"},realistic:{keywords:"photorealistic, hyperrealistic detail, natural lighting, authentic textures, lifelike rendering, professional photography, 8K quality",guidelines:"Create highly detailed realistic scenes with accurate lighting, realistic skin textures, natural environments, and documentary-style composition.",negativePrompt:"text, words, letters, cartoon, anime, painted, artificial, stylized, illustration, drawing"},"flat-design":{keywords:"flat design, vector art, solid colors, 2D illustration, material design, simple shapes, no gradients, clean geometric",guidelines:"Create simple 2D compositions with solid colors, no shadows or gradients, material design inspired, clean vector-style shapes.",negativePrompt:"text, words, letters, 3D, gradients, shadows, complex textures, photorealistic, depth"},silhouette:{keywords:"silhouette art, high contrast, black shapes, backlit, shadow puppets, dramatic outline, solid black forms, colored background",guidelines:"Create high contrast images with solid black silhouettes against colored or bright backgrounds, focus on shape and form, dramatic backlighting effects.",negativePrompt:"text, words, letters, detailed features, gradients, mid-tones, complex textures, facial details"},isometric:{keywords:"isometric view, 30 degree angle, simple 3D, geometric blocks, pixel art style, clean lines, technical illustration, grid-based",guidelines:"Create isometric 3D scenes with 30-degree angles, simple geometric shapes, clean technical illustration style, grid-based compositions.",negativePrompt:"text, words, letters, perspective distortion, complex textures, organic shapes, realistic lighting"},"line-art":{keywords:"line art, contour drawing, single line, outline only, pen sketch, minimalist drawing, black lines, white background",guidelines:"Create simple line drawings with single color outlines, no fills or shading, focus on contours and essential forms, pen sketch aesthetic.",negativePrompt:"text, words, letters, filled shapes, colors, gradients, shading, complex details, photorealistic"},duotone:{keywords:"duotone, two colors, limited palette, high contrast, graphic design, bold color scheme, simple two-tone",guidelines:"Create images using only two colors, high contrast between them, graphic design approach, bold visual impact through color limitation.",negativePrompt:"text, words, letters, multiple colors, gradients, complex color schemes, photorealistic, detailed textures"},"abstract-geometric":{keywords:"abstract geometric, basic shapes, triangles circles squares, pattern design, mathematical precision, clean geometry, modernist",guidelines:"Create abstract compositions using basic geometric shapes, mathematical precision, clean patterns, focus on shape relationships and balance.",negativePrompt:"text, words, letters, organic forms, realistic objects, complex textures, representational art"},bauhaus:{keywords:"bauhaus style, modernist, primary colors, geometric composition, clean design, functional aesthetic, red yellow blue black",guidelines:"Create clean modernist compositions with primary colors, geometric forms, Bauhaus school principles, functional beauty, grid-based layouts.",negativePrompt:"text, words, letters, ornate details, complex textures, organic shapes, pastel colors, realistic"},liminal:{keywords:"liminal space, empty hallway, fluorescent lights, backrooms, abandoned mall, uncanny, endless corridors, yellow rooms",guidelines:"Create unsettling empty spaces with fluorescent lighting, endless hallways, abandoned locations, uncanny atmosphere, no people present.",negativePrompt:"text, words, letters, people, crowds, cozy, warm lighting, lived-in spaces, outdoor nature"},"analog-horror":{keywords:"analog horror, VHS quality, static noise, found footage, grainy video, surveillance camera, distorted, glitch effects",guidelines:"Create grainy, low-quality footage aesthetic with VHS artifacts, static interference, surveillance camera look, intentionally degraded quality.",negativePrompt:"text, words, letters, HD quality, sharp details, modern technology, clean image, high resolution"},"stark-horror":{keywords:"stark horror, high contrast, black white red only, minimal horror, sharp shadows, simple shapes, disturbing silhouettes",guidelines:"Create high contrast horror using only black, white, and red, minimal but disturbing compositions, sharp dramatic shadows.",negativePrompt:"text, words, letters, multiple colors, soft lighting, complex details, gradients, cheerful elements"},vaporwave:{keywords:"vaporwave aesthetic, pink purple teal, windows 95, glitch art, nostalgic, mall aesthetic, retro computer, neon grid",guidelines:"Create nostalgic 90s computer aesthetic with pink/purple/teal palette, glitch effects, retro technology, mall and corporate imagery.",negativePrompt:"text, words, letters, modern technology, realistic, natural colors, high definition, contemporary style"},"deep-fried":{keywords:"deep fried meme, oversaturated, high contrast, glowing eyes, distorted, internet meme style, extreme filters, lens flare",guidelines:"Create intentionally over-processed images with extreme saturation, high contrast, glowing effects, meme-style distortion.",negativePrompt:"text, words, letters, subtle colors, natural lighting, professional quality, clean image, realistic"},"y2k-digital":{keywords:"Y2K aesthetic, early internet, matrix digital rain, windows XP, simple cyber, low poly, tech optimism, translucent plastic",guidelines:"Create early 2000s digital aesthetic with matrix-like elements, Windows XP vibes, low poly 3D, tech optimism, simple cyber elements.",negativePrompt:"text, words, letters, modern UI, high poly, realistic textures, vintage pre-digital, contemporary design"},storybook:{keywords:"storybook illustration, children's book art, simple characters, flat illustration, fairy tale style, whimsical, soft colors",guidelines:"Create simple, charming illustrations like children's books, clear focal points, minimal backgrounds, fairy tale aesthetic.",negativePrompt:"text, words, letters, photorealistic, complex details, dark themes, adult content, harsh lighting"},"comic-noir":{keywords:"noir style, black and white, dramatic shadows, high contrast, visual narrative, sin city aesthetic, one accent color",guidelines:"Create dramatic black and white scenes with optional single accent color, strong shadows, noir atmosphere, visual storytelling.",negativePrompt:"text, words, letters, speech bubbles, multiple colors, soft lighting, cheerful mood, low contrast"},"puppet-theater":{keywords:"puppet show aesthetic, theatrical stage, spotlight lighting, simple backdrop, marionette style, dramatic staging, curtains",guidelines:"Create theatrical puppet show scenes with stage lighting, simple painted backdrops, dramatic spotlights, theatrical composition.",negativePrompt:"text, words, letters, realistic humans, natural lighting, complex backgrounds, photorealistic, outdoor scenes"},diorama:{keywords:"diorama style, miniature scene, tilt shift, model railway, tiny world, shoebox scene, forced perspective, craft materials",guidelines:"Create miniature world aesthetic with tilt-shift effect, shoebox diorama look, model-like scenes, clear boundaries, craft material textures.",negativePrompt:"text, words, letters, full scale, normal perspective, realistic proportions, infinite depth, natural landscapes"},"security-cam":{keywords:"security camera footage, CCTV, surveillance, grainy monochrome, fish eye lens, low quality, timestamp overlay, static",guidelines:"Create CCTV surveillance footage aesthetic with grainy quality, monochrome or washed colors, slight fish-eye distortion, low resolution.",negativePrompt:"text, words, letters, HD quality, vibrant colors, artistic composition, professional photography, clear details"},"night-vision":{keywords:"night vision, infrared camera, green tint, heavy grain, military footage, ghost hunting, thermal artifacts, glowing eyes",guidelines:"Create night vision camera aesthetic with green tint, heavy noise, military or paranormal investigation feel, infrared artifacts.",negativePrompt:"text, words, letters, natural colors, daylight, clear image, low noise, professional quality, full color"},"trail-cam":{keywords:"trail camera, wildlife cam, motion triggered, harsh flash, grainy outdoor, cryptid footage, forest surveillance, infrared",guidelines:"Create trail camera aesthetic with harsh flash lighting, grainy quality, outdoor forest settings, motion blur, surveillance feel.",negativePrompt:"text, words, letters, studio lighting, urban settings, high quality, professional photography, indoor scenes"},classified:{keywords:"classified footage, degraded video, photocopied aesthetic, leaked tape, government archive, redacted, low quality transfer",guidelines:"Create degraded footage aesthetic suggesting classified or leaked material, photocopied quality, archival damage, mysterious origin.",negativePrompt:"text, words, letters, HD quality, modern footage, clean image, professional production, commercial quality"},"old-newsreel":{keywords:"vintage newsreel, old film grain, 1960s footage, scratched film, archival footage, black and white, film artifacts",guidelines:"Create vintage newsreel aesthetic with film grain, scratches, light leaks, black and white or faded color, 1950s-60s look.",negativePrompt:"text, words, letters, modern quality, digital artifacts, contemporary subjects, HD resolution, clean image"},"super-8":{keywords:"super 8 film, home movie, film grain, light leaks, vintage 8mm, amateur footage, warm nostalgic, handheld camera",guidelines:"Create super 8 home movie aesthetic with warm colors, film grain, light leaks, slight shake, amateur filming quality.",negativePrompt:"text, words, letters, professional quality, digital look, steady shots, modern technology, cold colors"},"polaroid-horror":{keywords:"polaroid photo, instant film, faded colors, creepy polaroid, found photos, yellowed edges, mysterious subjects, vintage instant",guidelines:"Create instant photo aesthetic with faded colors, white borders, slightly yellow/green tint, mysterious or unsettling subjects.",negativePrompt:"text, words, letters, digital photo, sharp details, modern quality, video footage, professional photography"},thermal:{keywords:"thermal imaging, heat signature, infrared thermal, FLIR camera, temperature visualization, hot cold gradient, scientific imaging",guidelines:"Create thermal camera aesthetic with heat signature visualization, blue to red color gradients, scientific/military imaging style.",negativePrompt:"text, words, letters, natural colors, normal photography, artistic style, complex details, realistic textures"}};const a=s[t]||s.cinematic;const r={tension:"visual tension, something about to happen, unresolved moment",mystery:"partially revealed element, obscured detail, intriguing shadow",contrast:"unexpected juxtaposition, size difference, light/dark drama",motion:"implied movement, dynamic energy, frozen action moment",focus:"extreme detail, macro view, selective emphasis",surprise:"unexpected element, scale revelation, hidden detail"};const o={cinematic:"depth of field, dramatic lighting, and powerful composition to create intrigue",anime:"expressive emotions, dynamic energy, and symbolic visual elements","dark-fantasy":"mysterious shadows, otherworldly atmosphere, and ominous beauty",minimalist:"one striking element with maximum impact through simplicity",cyberpunk:"neon-lit mystery, tech-noir atmosphere, and urban energy",retro:"nostalgic tension, vintage drama, and era-specific intrigue",surreal:"impossible situations, dreamlike confusion, and reality-bending visuals",realistic:"raw authentic moments, genuine emotion, and documentary-style impact","flat-design":"bold geometric shapes, striking color blocks, and clean visual hierarchy",silhouette:"dramatic contrast, mysterious forms, and powerful shape language",isometric:"impossible perspectives, geometric intrigue, and spatial puzzles","line-art":"elegant simplicity, flowing contours, and minimalist storytelling",duotone:"bold color contrast, graphic impact, and visual tension through limitation","abstract-geometric":"mathematical beauty, pattern intrigue, and shape relationships",bauhaus:"functional elegance, primary color drama, and modernist composition",liminal:"unsettling emptiness, uncanny spaces, and psychological unease","analog-horror":"degraded mystery, found footage tension, and technological decay","stark-horror":"minimal terror, high contrast fear, and simple but disturbing imagery",vaporwave:"nostalgic glitch, aesthetic contradiction, and digital dreamscapes","deep-fried":"chaotic energy, meme aesthetics, and intentional visual overload","y2k-digital":"cyber optimism, digital nostalgia, and turn-of-millennium tech magic",storybook:"whimsical charm, narrative clarity, and fairy tale wonder","comic-noir":"dramatic shadows, visual storytelling, and noir atmosphere without words","puppet-theater":"theatrical staging, dramatic spotlights, and performance energy",diorama:"miniature worlds, forced perspective, and crafted reality","security-cam":"surveillance tension, grainy mystery, and voyeuristic unease","night-vision":"infrared revelation, military tension, and hidden threats","trail-cam":"wilderness mystery, motion-triggered surprise, and cryptid potential",classified:"degraded secrets, archival mystery, and forbidden knowledge","old-newsreel":"historical drama, archival authenticity, and vintage documentation","super-8":"nostalgic moments, home movie warmth, and personal memories","polaroid-horror":"instant dread, faded memories, and found photo mystery",thermal:"heat signatures, scientific intrigue, and hidden temperature stories"}[t]||"powerful visual composition and emotional impact";const n=`You are an expert at creating image generation prompts for ${t} visual style.\n\nVISUAL STYLE DEFINITION:\n- Keywords: ${a.keywords}\n- Guidelines: ${a.guidelines}\n- Avoid: ${a.negativePrompt}\n\nFIRST IMAGE HOOK REQUIREMENTS (CRITICAL):\n- The FIRST image must stop viewers from scrolling - it appears in the first 3 seconds\n- Create immediate visual intrigue using ${t} aesthetic principles\n- Use ${o}\n- Psychological hooks to employ: ${Object.values(r).join(", ")}\n- Make viewers think "Wait, what?" or "I need to see more"\n- AVOID: Generic establishing shots, calm scenes, obvious visuals\n- The first prompt should have 2x the visual impact of subsequent prompts\n\nTASK:\nTransform narration text into detailed visual scenes that match the ${t} style.\n\nCRITICAL REQUIREMENTS:\n1. Create one image prompt per script section\n2. NEVER include text, words, letters, numbers, or writing in the image\n3. Transform spoken concepts into visual metaphors and scenes\n4. Include style keywords naturally in each prompt\n5. Describe composition, lighting, colors, mood, and specific visual elements\n6. Maintain visual consistency across all prompts\n7. FIRST IMAGE must be extraordinarily attention-grabbing within the style\n\nVISUAL TRANSFORMATION RULES:\n- Numbers/statistics → Visual representations (crowds, stacks, comparisons)\n- Text/quotes → Show the emotion or action instead\n- Explanations → Visual metaphors for the concept\n- Always describe WHAT TO SHOW, not what to say\n\nRESPONSE FORMAT:\nReturn ONLY a valid JSON object starting with { and ending with }\n\nExample format:\n{\n  "imagePrompts": [\n    {\n      "sectionId": "section_1",\n      "prompt": "Detailed prompt incorporating ${t} style elements",\n      "negativePrompt": "${a.negativePrompt}",\n      "style": "${a.keywords}"\n    }\n  ]\n}`;const l=e.script.scenes[0]?.text||e.script.scenes[0]?.imagePrompt||"";const c=this.analyzeHookType(l);logger_1.logger.info("[ImagePromptNode] First scene hook analysis:",{visualStyle:t,hookType:c,firstScenePreview:l.substring(0,100)+"...",styleHookLanguage:o});const d=[{role:"system",content:n},{role:"user",content:`Create image prompts for these scenes:\n${e.script.scenes.map((e,t)=>{const i=0===t?` [CRITICAL HOOK SCENE - ${c} - Must create immediate visual intrigue using ${o}]`:"";return e.imagePrompt?`Section ${t+1} (${e.id})${i}: ${e.imagePrompt} (${e.duration}s)`:`Section ${t+1} (${e.id})${i}: ${e.text} (${e.duration}s)`}).join("\n")}`}];await this.updateProgress(30);if(!this.llmClient)throw new Error("LLM client not initialized. Check API token configuration.");const m=await this.llmClient.complete({model:i,messages:d,temperature:.1,maxTokens:2e3});await this.updateProgress(80);if(!m.success||!m.data)throw new Error(m.error||"Failed to generate image prompts");let g=m.data.content;if(!g||""===g.trim()){logger_1.logger.error("[ImagePromptNode] Empty response from LLM");const t=e.script.scenes.map(e=>({sectionId:e.id,prompt:e.imagePrompt?`${a.keywords} visual scene without any text. ${e.imagePrompt}. Professional composition, perfect lighting, high quality render, no words or letters visible`:`${a.keywords} visual scene without any text. Visual representation of: ${e.text}. Professional composition, perfect lighting, high quality render, no words or letters visible`,negativePrompt:a.negativePrompt,style:a.keywords,duration:e.duration||5}));return{success:true,data:{imagePrompts:t},metadata:{nodeId:this.config.id,model:i,cost:m.metadata?.cost,promptCount:t.length,fallbackUsed:true}}}if(g.includes("```json"))g=g.replace(/```json\s*/g,"").replace(/```/g,"").trim();else if(g.includes("```"))g=g.replace(/```\s*/g,"").trim();const p=g.match(/\{[\s\S]*"imagePrompts"[\s\S]*\}/m);if(p)g=p[0];const u=g.indexOf("{");const h=g.lastIndexOf("}");if(u>=0&&h>u)g=g.substring(u,h+1);let y;try{y=JSON.parse(g)}catch(t){logger_1.logger.error("[ImagePromptNode] JSON parse error:",t);logger_1.logger.error("[ImagePromptNode] Failed to parse content:",g);y={imagePrompts:e.script.scenes.map(e=>({sectionId:e.id,prompt:e.imagePrompt?`${a.keywords} visual scene without any text. ${e.imagePrompt}. Professional composition, perfect lighting, high quality render, no words or letters visible`:`${a.keywords} visual scene without any text. Visual representation of: ${e.text}. Professional composition, perfect lighting, high quality render, no words or letters visible`,negativePrompt:a.negativePrompt,style:a.keywords}))}}const w=y.imagePrompts.map((t,i)=>{if(t&&"object"===typeof t)return{...t,duration:e.script.scenes[i]?.duration||4};return{duration:e.script.scenes[i]?.duration||4}});await this.updateProgress(100);return{success:true,data:{imagePrompts:w},metadata:{nodeId:this.config.id,model:i,cost:m.metadata?.cost,promptCount:w.length}}}catch(e){return{success:false,error:e instanceof Error?e.message:"Failed to generate image prompts"}}}validateCustom(e){const t=e;if(!t.script)return"Script data is required for image prompt generation";if(!t.script.scenes||0===t.script.scenes.length)return"Script must contain at least one scene";return null}analyzeHookType(e){const t=e.toLowerCase();if(t.includes("?")||t.includes("how")||t.includes("why"))return"question-based curiosity hook";if(t.includes("secret")||t.includes("truth")||t.includes("don't want you to know"))return"forbidden knowledge hook";if(t.includes("$")||t.includes("rich")||t.includes("money")||t.includes("wealth"))return"aspirational/financial hook";if(t.includes("shocking")||t.includes("unbelievable")||t.includes("crazy"))return"shock value hook";if(t.includes("mistake")||t.includes("wrong")||t.includes("stop"))return"warning/urgency hook";if(t.includes("discover")||t.includes("found")||t.includes("reveal"))return"discovery/revelation hook";return"attention-grabbing hook"}}exports.ImagePromptNode=ImagePromptNode;