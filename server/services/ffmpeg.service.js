"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,i){void 0===i&&(i=a);var r=Object.getOwnPropertyDescriptor(t,a);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[a]}}),Object.defineProperty(e,i,r)}:function(e,t,a,i){void 0===i&&(i=a),e[i]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(){var ownKeys=function(e){return ownKeys=Object.getOwnPropertyNames||function(e){var t=[];for(var a in e)Object.prototype.hasOwnProperty.call(e,a)&&(t[t.length]=a);return t},ownKeys(e)};return function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a=ownKeys(e),i=0;i<a.length;i++)"default"!==a[i]&&__createBinding(t,e,a[i]);return __setModuleDefault(t,e),t}}();Object.defineProperty(exports,"__esModule",{value:!0}),exports.FFmpegService=void 0;const fs=__importStar(require("fs/promises")),path=__importStar(require("path")),FFmpegUtils_1=require("./ffmpeg/FFmpegUtils"),logger_1=require("../utils/logger"),execWithPATH=(e,t)=>FFmpegUtils_1.FFmpegUtils.execWithFFmpeg(e,t);class FFmpegService{tempDir;constructor(){this.tempDir=path.join(process.cwd(),"temp")}async initialize(){await this.ensureTempDir()}async ensureTempDir(){try{await fs.access(this.tempDir)}catch{await fs.mkdir(this.tempDir,{recursive:!0})}}async checkFFmpeg(){try{await FFmpegUtils_1.FFmpegUtils.initialize();const e=await FFmpegUtils_1.FFmpegUtils.checkAvailability();return logger_1.logger.debug("[FFmpegService] FFmpeg availability check:",{ffmpeg:e.ffmpeg,ffprobe:e.ffprobe,ffmpegPath:e.ffmpegPath,ffprobePath:e.ffprobePath}),!0}catch(e){const t=e instanceof Error?e.message:String(e);throw logger_1.logger.error("[FFmpegService] FFmpeg check failed:",t),e}}async concatenateVideos(e,t,a){if(await this.checkFFmpeg(),!a){const a=path.join(this.tempDir,`concat_${Date.now()}.txt`),i=e.map(e=>`file '${e.path}'`).join("\n");await fs.writeFile(a,i);const r=`ffmpeg -loglevel error -f concat -safe 0 -i "${a}" -c copy "${t}" -y`;return await execWithPATH(r),await fs.unlink(a),t}return 2===e.length?this.crossfadeTwo(e[0],e[1],t,a):this.concatenateWithTransitions(e,t,a)}async crossfadeTwo(e,t,a,i){const r=e.duration-i.duration,o=`ffmpeg -i "${e.path}" -i "${t.path}" -filter_complex "[0:v][1:v]xfade=transition=${i.type}:duration=${i.duration}:offset=${r}[outv];[0:a][1:a]acrossfade=duration=${i.duration}[outa]" -map [outv] -map [outa] "${a}" -y`;return await execWithPATH(o),a}async concatenateWithTransitions(e,t,a){let i="",r="0:v",o="0:a";for(let t=1;t<e.length;t++){const n=e.slice(0,t).reduce((e,t)=>e+t.duration,0)-t*a.duration;i+=`[${r}][${t}:v]xfade=transition=${a.type}:duration=${a.duration}:offset=${n}[v${t}];`,i+=`[${o}][${t}:a]acrossfade=duration=${a.duration}[a${t}];`,r=`v${t}`,o=`a${t}`}const n=`ffmpeg ${e.map(e=>`-i "${e.path}"`).join(" ")} -filter_complex "${i}" -map [${r}] -map [${o}] "${t}" -y`;return await execWithPATH(n),t}async addAudioTrack(e,t,a,i=!0){await this.checkFFmpeg();const r=t.volume||.3;let o="";o=i?`-filter_complex "[1:a]volume=${r}[bg];[0:a][bg]amix=inputs=2:duration=first[outa]" -map 0:v -map [outa]`:"-map 0:v -map 1:a";const n=`ffmpeg -i "${e}" -i "${t.path}" ${o} -c:v copy "${a}" -y`;return await execWithPATH(n),a}async addSubtitles(e,t,a,i=!0){if(await this.checkFFmpeg(),i){const i=t.style||"",r=i?`:force_style='${i}'`:"",o=`ffmpeg -i "${e}" -vf "subtitles='${t.path}'${r}" -c:a copy "${a}" -y`;await execWithPATH(o)}else{const i=`ffmpeg -i "${e}" -i "${t.path}" -c copy -c:s mov_text "${a}" -y`;await execWithPATH(i)}return a}async generateSubtitlesFromAudio(e,t){throw new Error("Speech-to-text service not implemented. Use external service like Whisper or AssemblyAI")}async encodeVideo(e,t,a={}){await this.checkFFmpeg();const{codec:i="libx264",bitrate:r="2M",resolution:o,fps:n}=a;let c=`ffmpeg -i "${e}"`;return o&&(c+=` -vf scale=${o}`),n&&(c+=` -r ${n}`),c+=` -c:v ${i} -b:v ${r} -c:a aac -preset medium "${t}" -y`,await execWithPATH(c),t}async extractFrame(e,t,a){await this.checkFFmpeg();const i=`ffmpeg -ss ${t} -i "${e}" -vframes 1 "${a}" -y`;return await execWithPATH(i),a}async getVideoDuration(e){await this.checkFFmpeg();const t=`ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 "${e}"`,{stdout:a}=await execWithPATH(t);return parseFloat(a.trim())}async getVideoMetadata(videoPath){if(!videoPath||""===videoPath.trim())throw new Error(`Invalid video path for getVideoMetadata: videoPath="${videoPath}"`);await this.checkFFmpeg();const command=`ffprobe -v error -print_format json -show_format -show_streams "${videoPath}"`,{stdout:stdout}=await execWithPATH(command),info=JSON.parse(stdout),videoStream=info.streams.find(e=>"video"===e.codec_type),duration=parseFloat(info.format.duration||"0");return{duration:duration,width:videoStream?.width||1280,height:videoStream?.height||720,fps:videoStream?.r_frame_rate?eval(videoStream.r_frame_rate):30}}async addWatermark(e,t,a,i="bottomright"){await this.checkFFmpeg();const r=`ffmpeg -i "${e}" -i "${t}" -filter_complex "overlay=${{topleft:"10:10",topright:"W-w-10:10",bottomleft:"10:H-h-10",bottomright:"W-w-10:H-h-10"}[i]}" -c:a copy "${a}" -y`;return await execWithPATH(r),a}async createVideoFromImages(e,t,a=5,i){await this.checkFFmpeg();const r=[];for(let t=0;t<e.length;t++){const i=path.join(this.tempDir,`img_video_${t}_${Date.now()}.mp4`),o=`ffmpeg -loop 1 -i "${e[t]}" -c:v libx264 -t ${a} -pix_fmt yuv420p "${i}" -y`;await execWithPATH(o),r.push({path:i,duration:a})}const o=await this.concatenateVideos(r,t,i);for(const e of r)await fs.unlink(e.path);return o}async cleanup(){try{const e=await fs.readdir(this.tempDir);for(const t of e)await fs.unlink(path.join(this.tempDir,t))}catch(e){logger_1.logger.error("Cleanup error:",e)}}}exports.FFmpegService=FFmpegService;